# 电商系统回滚预案

## 文档信息
- **文档名称**: 电商系统回滚预案
- **版本**: 1.0
- **创建日期**: 2024-06-26
- **最后更新**: 2024-06-26
- **责任团队**: 开发团队、运维团队、质量保障团队

## 1. 回滚策略概述

回滚策略是保证系统在发生问题时能够快速恢复到稳定状态的关键流程。本预案详细描述了在电商系统上线后出现问题时，如何进行快速、安全的回滚操作。

### 1.1 回滚范围
- **前端应用**: 静态资源和前端代码
- **后端服务**: API服务和业务逻辑
- **数据库**: 数据结构和数据内容
- **配置文件**: 环境变量和服务配置

### 1.2 回滚优先级
1. **数据一致性**: 确保数据完整性和一致性
2. **服务可用性**: 快速恢复核心业务功能
3. **用户体验**: 最小化对用户的影响

## 2. 回滚触发条件

当出现以下情况时，应考虑执行回滚操作：

### 2.1 严重级别触发条件（立即回滚）
- 核心业务功能（登录、注册、下单、支付等）完全不可用
- 系统出现数据丢失或数据损坏
- 严重安全漏洞被发现
- 系统响应时间超过10秒，导致大部分用户无法正常使用
- 服务崩溃或无法启动

### 2.2 警告级别触发条件（评估后决定）
- 非核心功能故障，但影响用户体验
- 系统性能明显下降（响应时间增加50%以上）
- 特定类型的用户报告相同错误
- 部分地区用户无法访问服务

### 2.3 回滚决策流程
1. 监控系统检测到异常或用户报告问题
2. 技术团队确认问题严重性和影响范围
3. 项目负责人评估是否需要回滚
4. 如决定回滚，启动回滚流程并通知相关团队
5. 执行回滚并验证结果
6. 记录回滚原因和执行过程

## 3. 回滚准备工作

### 3.1 上线前准备
- **完整备份**: 确保上线前对所有环境进行完整备份
  - 数据库备份: 执行 `node scripts/database_backup.js`
  - 应用代码备份: 创建当前版本的代码快照
  - 配置文件备份: 保存所有配置文件的副本
- **版本标记**: 在版本控制系统中使用明确的标签标记当前生产版本
- **回滚脚本**: 准备自动化回滚脚本

### 3.2 资源准备
- **回滚团队**: 明确回滚操作的负责人和团队成员
- **通信渠道**: 建立回滚期间的沟通机制
- **访问权限**: 确保团队成员有足够权限执行回滚操作

## 4. 回滚执行流程

### 4.1 数据库回滚

#### 4.1.1 准备阶段
1. 确认要回滚到的数据库版本
2. 停止所有写入操作: `pm2 stop shop-backend`
3. 执行数据库备份（最后一次备份）: `node scripts/database_backup.js --tag pre-rollback`

#### 4.1.2 执行阶段
1. 恢复数据库: `node scripts/database_backup.js --restore --backup-file [备份文件名]`
2. 验证数据完整性: 执行数据一致性检查脚本
3. 重启数据库服务（如有必要）: `systemctl restart mongodb`

### 4.2 后端服务回滚

#### 4.2.1 准备阶段
1. 确认要回滚到的代码版本
2. 记录当前配置: `cp -r config/ config.bak/`

#### 4.2.2 执行阶段
1. 切换到项目目录: `cd /var/www/shop/backend`
2. 回滚代码: `git checkout [回滚目标标签/提交ID]`
3. 恢复配置文件: `cp -r config.bak/* config/`
4. 安装依赖: `npm ci --production`
5. 重启服务: `pm2 restart shop-backend`
6. 检查服务状态: `pm2 status shop-backend`

### 4.3 前端应用回滚

#### 4.3.1 准备阶段
1. 确认要回滚到的前端版本
2. 记录当前静态资源状态

#### 4.3.2 执行阶段
1. 切换到前端目录: `cd /var/www/html/shop`
2. 备份当前前端: `mv /var/www/html/shop /var/www/html/shop.rollback`
3. 恢复上一版本: `cp -r /path/to/backup/shop-frontend-[版本号]/* /var/www/html/shop/`
4. 修复权限: `chown -R www-data:www-data /var/www/html/shop/`
5. 清除CDN缓存（如有）

### 4.4 配置文件回滚
1. 恢复环境变量文件: `cp .env.production.bak .env.production`
2. 恢复服务配置: `cp nginx.conf.bak nginx.conf`
3. 重载服务配置: `nginx -s reload`

## 5. 回滚验证

### 5.1 功能验证
执行以下测试确保系统功能正常：

#### 5.1.1 后端API验证
```bash
# 健康检查
curl -X GET http://localhost:5000/api/health

# 用户认证测试
curl -X POST http://localhost:5000/api/auth/login -H "Content-Type: application/json" -d '{"email":"test@example.com","password":"test123"}'

# 产品列表测试
curl -X GET http://localhost:5000/api/products
```

#### 5.1.2 前端功能验证
- 网站首页加载测试
- 用户登录/注册功能测试
- 产品浏览和搜索功能测试
- 购物车和结账流程测试

### 5.2 性能验证
- 检查API响应时间
- 监控服务器资源使用率
- 验证数据库连接和查询性能

### 5.3 数据验证
- 随机抽查关键数据记录
- 验证业务数据完整性
- 检查数据一致性

## 6. 回滚后工作

### 6.1 问题分析
- 收集并分析回滚原因
- 记录问题发生的具体时间和环境
- 分析日志文件查找根本原因

### 6.2 修复方案
- 基于问题分析制定修复计划
- 在测试环境验证修复方案
- 准备重新部署

### 6.3 文档更新
- 更新问题跟踪记录
- 修订上线流程以避免类似问题
- 更新回滚预案

### 6.4 团队沟通
- 向相关团队通报回滚结果
- 安排技术复盘会议
- 分享经验教训

## 7. 自动化回滚脚本

### 7.1 综合回滚脚本 (rollback.sh)
```bash
#!/bin/bash

# 电商系统回滚脚本
set -e

echo "===== 电商系统回滚开始 ====="

# 参数
BACKEND_DIR="/var/www/shop/backend"
FRONTEND_DIR="/var/www/html/shop"
BACKUP_DIR="/var/backups/shop"
ROLLBACK_VERSION=$1

if [ -z "$ROLLBACK_VERSION" ]; then
  echo "错误: 请指定回滚版本号"
  echo "用法: ./rollback.sh [版本号]"
  exit 1
fi

echo "回滚版本: $ROLLBACK_VERSION"

# 1. 停止服务
echo "停止后端服务..."
pm2 stop shop-backend

# 2. 数据库回滚
echo "执行数据库回滚..."
cd $BACKEND_DIR
node scripts/database_backup.js --restore --backup-file "$BACKUP_DIR/db_${ROLLBACK_VERSION}.tar.gz"

# 3. 后端服务回滚
echo "回滚后端服务..."
cd $BACKEND_DIR
git checkout "v${ROLLBACK_VERSION}"
npm ci --production

# 4. 前端应用回滚
echo "回滚前端应用..."
mv $FRONTEND_DIR $FRONTEND_DIR.rollback
cp -r "$BACKUP_DIR/frontend_${ROLLBACK_VERSION}" $FRONTEND_DIR
chown -R www-data:www-data $FRONTEND_DIR

# 5. 重启服务
echo "重启后端服务..."
pm2 start shop-backend

# 6. 验证
echo "验证服务状态..."
pm2 status shop-backend
echo "===== 电商系统回滚完成 ====="
echo "请执行功能验证确认系统正常运行"
```

### 7.2 数据库回滚脚本 (database_rollback.js)
```javascript
// 数据库回滚脚本
const mongoose = require('mongoose');
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

// 解析命令行参数
const args = process.argv.slice(2);
const backupFile = args.find(arg => arg.includes('--backup-file='))?.split('=')[1];
const confirmRollback = args.includes('--confirm');

if (!backupFile) {
  console.error('错误: 请指定备份文件');
  console.log('用法: node database_rollback.js --backup-file=[备份文件路径] --confirm');
  process.exit(1);
}

if (!confirmRollback) {
  console.warn('警告: 数据库回滚操作可能导致数据丢失');
  console.log('请使用 --confirm 参数确认执行回滚');
  process.exit(1);
}

console.log(`开始数据库回滚，使用备份文件: ${backupFile}`);

// 获取数据库连接信息
const mongoUri = process.env.MONGO_URI;
const matches = mongoUri.match(/mongodb:\/\/(.*?)\/(.*?)(\?|$)/);
const host = matches[1];
const dbName = matches[2];

const tempDir = path.join(__dirname, '../temp_restore');

// 创建临时目录
if (!fs.existsSync(tempDir)) {
  fs.mkdirSync(tempDir, { recursive: true });
}

console.log(`正在解压缩备份文件到 ${tempDir}...`);
// 解压备份文件
execSync(`tar -xzf "${backupFile}" -C "${tempDir}"`, { stdio: 'inherit' });

console.log('正在连接到数据库...');
// 连接到数据库
async function restoreDatabase() {
  try {
    // 断开现有连接
    if (mongoose.connection.readyState !== 0) {
      await mongoose.disconnect();
    }
    
    console.log(`正在恢复数据库: ${dbName} (${host})`);
    
    // 使用mongorestore命令恢复数据库
    execSync(`mongorestore --uri="${mongoUri}" "${tempDir}"`, { stdio: 'inherit' });
    
    console.log('数据库恢复成功！');
    
    // 清理临时目录
    fs.rmSync(tempDir, { recursive: true, force: true });
    console.log('临时文件已清理');
    
  } catch (error) {
    console.error('数据库恢复失败:', error.message);
    process.exit(1);
  } finally {
    // 确保清理临时文件
    if (fs.existsSync(tempDir)) {
      fs.rmSync(tempDir, { recursive: true, force: true });
    }
  }
}

restoreDatabase();
```

## 8. 回滚责任矩阵

| 角色 | 责任 | 联系人 | 联系方式 |
|------|------|--------|----------|
| 技术负责人 | 回滚决策、全程监督 | [姓名] | [电话/邮箱] |
| 后端开发工程师 | 后端服务回滚、API验证 | [姓名] | [电话/邮箱] |
| 前端开发工程师 | 前端应用回滚、功能验证 | [姓名] | [电话/邮箱] |
| 数据库管理员 | 数据库回滚、数据验证 | [姓名] | [电话/邮箱] |
| 运维工程师 | 服务器配置、服务重启 | [姓名] | [电话/邮箱] |
| 测试工程师 | 全面功能验证、测试报告 | [姓名] | [电话/邮箱] |
| 项目经理 | 协调沟通、进度跟踪 | [姓名] | [电话/邮箱] |

## 9. 回滚演练计划

### 9.1 演练频率
- 每季度执行一次完整回滚演练
- 每次重大版本上线前执行回滚演练

### 9.2 演练内容
- 模拟数据库损坏场景的回滚
- 模拟应用崩溃场景的回滚
- 测试自动化回滚脚本
- 评估回滚时间和影响

### 9.3 演练评估
- 记录回滚过程中发现的问题
- 优化回滚流程和脚本
- 更新回滚预案

## 10. 附录

### 10.1 常用命令参考

**数据库相关**
- 备份: `node scripts/database_backup.js`
- 恢复: `node scripts/database_backup.js --restore --backup-file=[文件名] --confirm`
- 检查状态: `mongo --eval "db.adminCommand('ping')"`

**服务相关**
- 启动: `pm2 start shop-backend`
- 停止: `pm2 stop shop-backend`
- 重启: `pm2 restart shop-backend`
- 状态: `pm2 status shop-backend`
- 日志: `pm2 logs shop-backend`

**文件系统相关**
- 复制: `cp -r [源] [目标]`
- 移动: `mv [源] [目标]`
- 权限: `chown -R www-data:www-data [目录]`

### 10.2 资源链接
- 监控系统: http://monitoring.shop.com
- 问题跟踪系统: http://jira.shop.com
- 代码仓库: http://github.com/shop/ecommerce
- 文档中心: http://docs.shop.com

---

**注意**: 本回滚预案应定期更新，确保与最新的系统架构和部署流程保持一致。每次执行回滚操作后，应记录执行过程和结果，并根据实际情况优化本预案。
