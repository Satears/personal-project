# 电商系统上线操作手册

## 文档信息
- **文档名称**: 电商系统上线操作手册
- **版本**: 1.0
- **创建日期**: 2024-06-26
- **最后更新**: 2024-06-26
- **责任团队**: 开发团队、运维团队

## 1. 项目概述

### 1.1 系统架构
电商系统采用前后端分离架构：
- **前端**: React + Vite + Ant Design
- **后端**: Node.js + Express + MongoDB
- **部署环境**: Linux服务器

### 1.2 主要功能模块
- 用户认证与授权
- 产品管理与展示
- 购物车功能
- 订单管理
- 支付集成

## 2. 上线前准备

### 2.1 环境准备
- 确保生产环境服务器已配置并可访问
- 检查Node.js环境版本 (推荐 v14+)
- 确认MongoDB数据库服务正常运行
- 验证Nginx配置正确

### 2.2 配置文件准备
- 确认生产环境配置文件 `.env.production` 已正确设置
- 检查数据库连接字符串和其他敏感信息
- 验证API端点和服务地址配置

#### 2.2.1 环境变量配置详解

**必须配置的环境变量：**

| 环境变量 | 说明 | 生产环境要求 |
|---------|------|------------|
| MONGO_URI | MongoDB连接字符串 | 必须使用生产数据库地址和强密码 |
| PORT | 服务器端口 | 通常为5000或8080 |
| NODE_ENV | 运行环境 | 生产环境必须设置为 `production` |
| JWT_SECRET | JWT签名密钥 | **强烈要求：** 使用强随机密钥，至少32字符 |
| JWT_EXPIRES_IN | JWT过期时间 | 建议设置为合理时间，如 `7d` |
| BCRYPT_SALT_ROUNDS | 密码加密轮数 | 至少10轮，生产环境建议12轮 |
| LOG_LEVEL | 日志级别 | 生产环境建议设置为 `error` |
| SMTP_PASSWORD | 邮件服务密码 | 用于发送系统通知邮件 |
| TWILIO_SID<br>TWILIO_AUTH_TOKEN | Twilio短信服务凭证 | 用于短信通知功能 |
| WEBHOOK_API_KEY | Webhook API密钥 | 用于系统间通信的安全认证 |
| SENTRY_DSN | 错误监控DSN | 用于收集和分析运行时错误 |
| API_BASE_URL | API基础URL | 生产环境API地址 |
| ALLOWED_ORIGINS | 允许的CORS来源 | 生产环境必须严格限制 |

**环境变量配置步骤：**
1. 从 `.env.example` 模板复制：
   ```bash
   cp .env.example .env
   ```
2. 生成强JWT密钥：
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```
3. 编辑 `.env` 文件，填入所有必要的环境变量值
4. 对于生产环境，确保使用 `.env.production` 文件

**安全注意事项：**
- 永远不要将包含实际敏感信息的环境变量文件提交到版本控制系统
- 定期轮换JWT密钥和其他敏感凭证
- 生产环境中使用环境变量注入方式，避免硬编码敏感信息
- 为不同环境（开发、测试、生产）使用不同的配置值

### 2.3 依赖检查
- 前端依赖: 运行 `npm ci` 确保依赖一致性
- 后端依赖: 运行 `npm ci` 确保依赖一致性

### 2.4 备份确认
- 数据库完整备份已执行
- 关键配置文件已备份
- 上一版本的代码和构建产物已归档

## 3. 部署流程

### 3.1 后端部署

#### 3.1.1 部署步骤
1. 连接到生产服务器
2. 切换到项目目录: `cd /var/www/shop/backend`
3. 从版本控制系统拉取最新代码: `git pull origin main`
4. 安装依赖: `npm ci --production`
5. 执行数据库迁移: `node scripts/database_migration.js`
6. 重启后端服务: `pm2 restart shop-backend`

#### 3.1.2 验证步骤
1. 检查服务状态: `pm2 status shop-backend`
2. 检查服务日志: `pm2 logs shop-backend --lines 100`
3. 访问健康检查端点: `curl http://localhost:5000/api/health`

### 3.2 前端部署

#### 3.2.1 构建步骤
1. 在构建服务器上拉取最新代码: `git pull origin main`
2. 安装依赖: `npm ci`
3. 执行构建: `npm run build`
4. 验证构建产物: `ls -la dist/`

#### 3.2.2 部署步骤
1. 将构建产物复制到生产服务器: `rsync -avz dist/ user@server:/var/www/html/shop/`
2. 验证文件权限: `chown -R www-data:www-data /var/www/html/shop/`

#### 3.2.3 验证步骤
1. 清除浏览器缓存
2. 访问网站首页并验证加载正常
3. 测试几个关键功能页面

## 4. 功能验证清单

### 4.1 前端功能验证
- [ ] 网站首页加载正常
- [ ] 用户登录/注册功能正常
- [ ] 产品列表和详情页面显示正常
- [ ] 搜索和筛选功能正常
- [ ] 购物车功能（添加、删除、更新数量）正常
- [ ] 结账流程正常
- [ ] 个人中心页面功能正常

### 4.2 后端API验证
- [ ] 用户认证API正常（登录、注册）
- [ ] 产品API正常（列表、详情）
- [ ] 购物车API正常（CRUD操作）
- [ ] 订单API正常（创建、查询）
- [ ] 支付API正常（模拟支付）

### 4.3 性能验证
- [ ] 首页加载时间 < 3秒
- [ ] 产品列表加载时间 < 2秒
- [ ] API平均响应时间 < 500ms

## 5. 回滚策略

### 5.1 触发回滚的条件
- 关键功能不可用
- 系统出现严重性能问题
- 出现数据一致性问题
- 用户报告大量错误

### 5.2 后端回滚步骤
1. 连接到生产服务器
2. 切换到项目目录: `cd /var/www/shop/backend`
3. 回滚到上一版本: `git checkout [上一版本标签或提交ID]`
4. 重新安装依赖: `npm ci --production`
5. 执行数据库回滚: `node scripts/database_rollback.js`
6. 重启服务: `pm2 restart shop-backend`
7. 验证服务状态和功能

### 5.3 前端回滚步骤
1. 连接到生产服务器
2. 删除当前构建: `rm -rf /var/www/html/shop/*`
3. 从备份恢复上一版本构建: `tar -xzf /path/to/backup/shop-frontend-previous.tar.gz -C /var/www/html/shop/`
4. 验证文件权限
5. 清除CDN缓存（如有）

## 6. 监控与告警

### 6.1 监控指标
- 服务器CPU和内存使用率
- API响应时间和错误率
- 数据库连接数和查询性能
- 用户流量和关键业务指标

### 6.2 告警阈值
- CPU使用率 > 90%: 严重告警
- 内存使用率 > 95%: 严重告警
- API错误率 > 5%: 严重告警
- API响应时间 > 500ms: 警告
- 服务不可用: 严重告警

### 6.3 告警通知
- 邮件通知: admin@shop.com, devops@shop.com
- SMS通知: +8612345678901 (仅严重告警)
- Webhook通知: 发送到Slack工作区

## 7. 常见问题处理

### 7.1 后端服务无法启动
- 检查端口是否被占用: `lsof -i :5000`
- 检查环境变量配置: `cat .env`
- 检查数据库连接: `mongo [connectionString]`
- 查看详细日志: `pm2 logs shop-backend`

### 7.2 前端页面加载错误
- 检查Nginx配置: `cat /etc/nginx/sites-available/shop`
- 验证文件权限: `ls -la /var/www/html/shop/`
- 检查API端点配置是否正确
- 查看浏览器控制台错误

### 7.3 数据库连接问题
- 检查MongoDB服务状态: `systemctl status mongodb`
- 验证连接字符串: `mongo [connectionString]`
- 检查数据库用户权限

## 8. 联系方式

### 8.1 紧急联系人
- **技术负责人**: [姓名] - [电话] - [邮箱]
- **运维负责人**: [姓名] - [电话] - [邮箱]
- **项目经理**: [姓名] - [电话] - [邮箱]

### 8.2 支持渠道
- 内部技术支持群: [Slack/企业微信/钉钉群链接]
- 监控系统地址: http://monitoring.shop.com

## 9. 上线后工作

### 9.1 监控要点
- 上线后24小时内密切监控系统性能
- 关注用户反馈和错误报告
- 检查日志中的异常情况

### 9.2 文档更新
- 记录本次上线的经验教训
- 更新系统架构图和文档
- 更新API文档

### 9.3 用户通知
- 发布版本更新说明
- 如有重大功能更新，提供用户引导

---

**注意**: 本操作手册应在每次上线前更新，确保所有步骤和配置都是最新的。执行上线操作时，请严格按照本手册的步骤进行，并记录每一步的执行结果。
